# frozen_string_literal: true

# Issue 15841 - SegFault in OpenSSL::PKey::RSA#private_encrypt

class TestIt < Minitest::Test

  require 'openssl'
  puts "  #{OpenSSL::OPENSSL_VERSION}  OPENSSL_VERSION",
       "  #{OpenSSL::OPENSSL_LIBRARY_VERSION}  OPENSSL_LIBRARY_VERSION"

  def test_15841
    modulus = OpenSSL::BN.new('126914039353434453831661971268647447269232081862082764501010934367441434199199964254884893447916776634375786528636229937728173623541291144426274921409848997181513107190580453415730826852070626720125773687471242\
      611642649234390348699947633571205684722799950579951120477619298143923772148965919919195784168283711', 10)

    public_exponent = OpenSSL::BN.new('65537', 10)

    private_exponent = OpenSSL::BN.new('341964495821065129936072986248372022243660770187105326365541869938588248782459643985676392231199635777382326886137241414828657902188760530546426203854726301121665061632837569847323878241274517300277489\
      6102686920500059152100016165854694372963975060765003171003826784408362498480661236694500218201182323054913', 10)
    prime1 = OpenSSL::BN.new('11952373024606947105152469897150254148042322654516052874548960228374163164391052864033557517269946782417764389875359650595699633451962690417812447456789781', 10)
    prime2 = OpenSSL::BN.new('10618313124276675806272072098863521356129998721878748974728637357066521302704987846522920724710466419737573058767973827707394086143442677100153976677110531', 10)

    rsa = OpenSSL::PKey::RSA.new
    rsa.set_key(modulus, public_exponent, nil)
    rsa.set_factors(prime1, prime2)

    assert_raises(OpenSSL::PKey::RSAError) { rsa.private_encrypt 'plaintext' }
  end
end
